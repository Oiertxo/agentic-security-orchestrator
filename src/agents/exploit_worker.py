from langchain_core.messages import HumanMessage
from langchain_core.runnables import RunnableConfig
from src.state import AgentState, ExploitState
from src.subgraphs.exploit.exploit_subgraph import exploit_subgraph
from langfuse import observe
from src.logger import logger

@observe(name="Exploit Worker")
def exploit_worker_node(state: AgentState, config: RunnableConfig) -> AgentState:
    old_exploit = state.get("exploit") or {}
    out = exploit_subgraph.invoke(state, config)
    logger.info(f"[EXPLOIT_WORKER_NODE] Output: {out}")
    
    exploit_out: ExploitState = out.get("exploit") or {}
    exploit_out["finished"] = bool(exploit_out.get("finished", False))
    summary = {
        "results": exploit_out.get("results", ["Exploit not available"]),
        "steps": exploit_out.get("step_count", 0),
    }

    return {
        "user_target": state.get("user_target"),
        "exploit": {
            **old_exploit,
            **exploit_out
        },
        "messages": state["messages"] + [HumanMessage(content=f"[SOURCE: RECON]\n{summary}")],
        "next_step": "supervisor"
    }

def exploit_worker_node_mock(state: AgentState) -> AgentState:
    logger.info("--- MOCK EXPLOIT ---")

    technical_output = """
        [SOURCE: EXPLOIT]
        TARGET: 10.255.255.10
        FINDINGS:
        - OBTAINED REMOTE SHELL
        [/END_REPORT]
        """
    exploit_state: ExploitState = state.get("exploit") or {}
    return {
        "user_target": state.get("user_target"),
        "exploit": {
            **exploit_state,
            "results": [{
                "10.255.255.10": "OBTAINED REMOTE SHELL"
            }]
        },
        "messages": [HumanMessage(content=technical_output)],
        "next_step": "supervisor"
    }