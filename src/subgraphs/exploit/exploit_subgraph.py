from langgraph.graph import StateGraph, END
from src.state import AgentState
from .exploit_planner import exploit_planner_node
from .exploit_executor import exploit_executor_node
from langfuse import observe

MAX_EXPLOIT_STEPS = 20

@observe(name="Exploit subgraph")
def build_exploit_subgraph():
    graph = StateGraph(AgentState)

    graph.add_node("planner", exploit_planner_node)
    graph.add_node("executor", exploit_executor_node)

    graph.set_entry_point("planner")

    def route_from_planner(state: AgentState):
        exploit = state.get("exploit", {}) or {}
        step = int(exploit.get("step_count", 0))
        finished = bool(exploit.get("finished", False))

        if finished or step >= MAX_EXPLOIT_STEPS:
            return "finish"
        return "executor"

    graph.add_conditional_edges(
        "planner",
        route_from_planner,
        {"finish": END, "executor": "executor"}
    )
    graph.add_edge("executor", "planner")
    return graph.compile()

exploit_subgraph = build_exploit_subgraph()